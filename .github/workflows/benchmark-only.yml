name: Run Benchmarks Only

on:
  workflow_dispatch:
    inputs:
      config_override:
        description: 'Custom configuration JSON (optional)'
        required: false
        type: string
      iterations:
        description: 'Number of iterations'
        required: false
        default: '10'
        type: string
      network_conditions:
        description: 'Network conditions to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - slow_4g_only
          - no_throttling_only

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd dashboard && npm ci && cd ..

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Prepare configuration
        run: |
          if [ -n "${{ github.event.inputs.config_override }}" ]; then
            echo "MAGIC_BENCHMARKING_CONFIG=${{ github.event.inputs.config_override }}" >> $GITHUB_ENV
          else
            # Create configuration based on inputs
            SLOW_4G_ENABLED="true"
            NO_THROTTLING_ENABLED="true"
            
            if [ "${{ github.event.inputs.network_conditions }}" == "slow_4g_only" ]; then
              NO_THROTTLING_ENABLED="false"
            elif [ "${{ github.event.inputs.network_conditions }}" == "no_throttling_only" ]; then
              SLOW_4G_ENABLED="false"
            fi
            
            cat > benchmark_config.json << EOF
          {
            "products": [
              {
                "name": "MagicCheckout",
                "entry_url": "https://razorpay.com/demopg3/",
                "pom_file": "magic-checkout",
                "enabled": true
              }
            ],
            "execution_matrix": {
              "network": {
                "slow_4g": {
                  "download_throughput": 500000,
                  "upload_throughput": 500000,
                  "latency": 400,
                  "enabled": ${SLOW_4G_ENABLED}
                },
                "no_throttling": {
                  "download_throughput": 0,
                  "upload_throughput": 0,
                  "latency": 0,
                  "enabled": ${NO_THROTTLING_ENABLED}
                }
              },
              "cpu": {
                "no_throttling": {
                  "rate": 1,
                  "enabled": true
                }
              },
              "user_state": {
                "new_user": {
                  "is_logged_in": true,
                  "enabled": true
                }
              }
            },
            "execution": {
              "iterations": ${{ github.event.inputs.iterations }},
              "timeout": 120000,
              "headless": true,
              "browsers": ["chromium"],
              "retry": {
                "max_attempts": 3,
                "delay_between_retries": 3000,
                "save_progress_on_failure": true
              }
            },
            "output": {
              "formats": ["json", "csv"],
              "directory": "./dashboard/public/results"
            }
          }
          EOF
            echo "MAGIC_BENCHMARKING_CONFIG=$(cat benchmark_config.json | jq -c .)" >> $GITHUB_ENV
          fi

      - name: Run benchmarking
        run: |
          echo "Starting benchmarking with configuration:"
          echo "$MAGIC_BENCHMARKING_CONFIG" | jq .
          npm run build
          npm start
        env:
          CI: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}-${{ github.run_attempt }}
          path: dashboard/public/results/
          retention-days: 7

      - name: Display results summary
        run: |
          echo "ðŸ“Š Benchmark Results Summary:"
          echo "================================"
          for file in dashboard/public/results/*.json; do
            if [[ -f "$file" && "$file" != *"network-analysis"* ]]; then
              echo "ðŸ“„ $(basename "$file")"
              echo "   Size: $(du -h "$file" | cut -f1)"
              echo "   Modified: $(date -r "$file")"
            fi
          done
          echo "================================"
          echo "âœ… Benchmarking completed successfully!"
          echo "Results are available in the artifacts section."
